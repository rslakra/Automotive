<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Schedules - RSLakra's Auto Service</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<div class="container mt-5">
    <div class="row">
        <div class="col-12">
            <h2>Available Schedules</h2>
            <p class="text-muted">Select an available time slot to book your service appointment</p>
            
            <!-- Error message if schedule not available -->
            <div th:if="${param.error != null and param.error[0] == 'notAvailable'}" class="alert alert-warning alert-dismissible fade show" role="alert">
                <strong>Schedule Not Available!</strong> The selected schedule is no longer available. Please choose another time slot.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        </div>
    </div>
    
    <!-- Admin: Generate Schedules Section -->
    <div class="row mt-4" sec:authorize="hasAuthority('ADMIN')">
        <div class="col-12">
            <div class="card bg-light mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Admin: Generate Schedules</h5>
                </div>
                <div class="card-body">
                    <form th:action="@{/schedules/generate}" method="post" class="row g-3">
                        <div class="col-md-4">
                            <label for="startDate" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="startDate" name="startDate" required/>
                        </div>
                        <div class="col-md-4">
                            <label for="endDate" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="endDate" name="endDate" required/>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <button type="submit" class="btn btn-success">Generate Default Slots</button>
                        </div>
                        <div class="col-12">
                            <small class="text-muted">Generates hourly slots from 9 AM - 5 PM (excluding lunch 12-1 PM) for weekdays</small>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin: Add Single Schedule -->
    <div class="row" sec:authorize="hasAuthority('ADMIN')">
        <div class="col-12">
            <div class="card bg-light mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Admin: Add Single Schedule</h5>
                </div>
                <div class="card-body">
                    <form th:action="@{/schedules/save}" method="post" th:object="${schedule}" class="row g-3">
                        <div class="col-md-3">
                            <label for="scheduleDate" class="form-label">Date</label>
                            <input type="date" class="form-control" id="scheduleDate" th:field="*{scheduleDate}" required/>
                        </div>
                        <div class="col-md-2">
                            <label for="startTime" class="form-label">Start Time</label>
                            <input type="time" class="form-control" id="startTime" th:field="*{startTime}" required/>
                        </div>
                        <div class="col-md-2">
                            <label for="endTime" class="form-label">End Time</label>
                            <input type="time" class="form-control" id="endTime" th:field="*{endTime}" required/>
                        </div>
                        <div class="col-md-2">
                            <label for="maxAppointments" class="form-label">Max Appointments</label>
                            <input type="number" class="form-control" id="maxAppointments" th:field="*{maxAppointments}" min="1" value="2"/>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <button type="submit" class="btn btn-primary">Add Schedule</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Schedules Table -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                    <tr>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Availability</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="schedule : ${schedules}">
                        <td th:text="${#temporals.format(schedule.scheduleDate, 'EEE, MMM dd, yyyy')}">Mon, Jan 01, 2025</td>
                        <td th:text="${#temporals.format(schedule.startTime, 'hh:mm a') + ' - ' + #temporals.format(schedule.endTime, 'hh:mm a')}">10:00 AM - 11:00 AM</td>
                        <td>
                            <span th:text="${schedule.currentAppointments + '/' + schedule.maxAppointments}">0/2</span>
                        </td>
                        <td>
                            <span th:if="${schedule.hasAvailability()}" class="badge bg-success">Available</span>
                            <span th:unless="${schedule.hasAvailability()}" class="badge bg-secondary">Booked</span>
                        </td>
                        <td>
                            <!-- User: Book appointment -->
                            <a th:if="${schedule.hasAvailability()}" 
                               th:href="@{/appointments/new(scheduleId=${schedule.id})}" 
                               class="btn btn-sm btn-primary"
                               sec:authorize="isAuthenticated()">Book Now</a>
                            <a th:if="${schedule.hasAvailability()}" 
                               th:href="@{/login}" 
                               class="btn btn-sm btn-outline-primary"
                               sec:authorize="!isAuthenticated()">Login to Book</a>
                            
                            <!-- Admin: Manage schedule -->
                            <span sec:authorize="hasAuthority('ADMIN')" class="ms-2">
                                <a th:href="@{/schedules/toggle/{id}(id=${schedule.id})}" 
                                   class="btn btn-sm"
                                   th:classappend="${schedule.available} ? 'btn-outline-warning' : 'btn-outline-success'"
                                   th:text="${schedule.available} ? 'Disable' : 'Enable'">Toggle</a>
                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                        data-bs-toggle="modal" 
                                        th:data-bs-target="'#deleteModal' + ${schedule.id}">Delete</button>
                            </span>
                        </td>
                    </tr>
                    <tr th:if="${schedules == null or #lists.isEmpty(schedules)}">
                        <td colspan="5" class="text-center text-muted py-4">
                            <p class="mb-2">No schedules available</p>
                            <span sec:authorize="hasAuthority('ADMIN')">
                                Use the form above to generate or add schedules.
                            </span>
                            <span sec:authorize="!hasAuthority('ADMIN')">
                                Please check back later for available schedules.
                            </span>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modals (one per schedule for admin) -->
<th:block th:each="schedule : ${schedules}" sec:authorize="hasAuthority('ADMIN')">
    <div class="modal fade" th:id="'deleteModal' + ${schedule.id}" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>Delete Schedule
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-0">Are you sure you want to delete this schedule?</p>
                    <p class="text-muted mt-2 mb-0">
                        <strong th:text="${#temporals.format(schedule.scheduleDate, 'EEE, MMM dd, yyyy')}">Date</strong> - 
                        <span th:text="${#temporals.format(schedule.startTime, 'hh:mm a') + ' - ' + #temporals.format(schedule.endTime, 'hh:mm a')}">Time</span>
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No, Keep It</button>
                    <a th:href="@{/schedules/delete/{id}(id=${schedule.id})}" class="btn btn-danger">Yes, Delete Schedule</a>
                </div>
            </div>
        </div>
    </div>
</th:block>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Set minimum dates to today
    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date().toISOString().split('T')[0];
        const dateInputs = document.querySelectorAll('input[type="date"]');
        dateInputs.forEach(function(input) {
            input.setAttribute('min', today);
        });
    });
</script>
</body>
</html>
